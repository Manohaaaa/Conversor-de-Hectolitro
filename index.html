<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Hectolitros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        :root {
            --main-green: #007F2D;
            --neutral-gray: #BDBCBC;
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Simple animation for list items */
        .list-item-enter {
            opacity: 0;
            transform: translateY(-10px);
            animation: enter 0.3s forwards;
        }
        @keyframes enter {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .total-hl-color { color: var(--main-green); }
        .btn-calculate { background-color: var(--main-green); }
        .secondary-text { color: var(--neutral-gray); }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">üß† Calculadora de Hectolitros</h1>
            <p class="secondary-text mt-2">Pesquise, adicione produtos e calcule o volume total em HL.</p>
        </header>

        <!-- Total Display -->
        <div id="total-container" class="sticky top-0 z-10 bg-gray-900/80 backdrop-blur-sm py-4 mb-6">
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 text-center">
                <p class="text-lg secondary-text">Subtotal Geral (HL)</p>
                <p id="total-hl" class="text-4xl font-bold total-hl-color">0.000</p>
            </div>
        </div>

        <!-- Search Section -->
        <div class="mb-6 relative">
            <label for="search-input" class="sr-only">Pesquisar Produto</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 secondary-text" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="text" id="search-input" placeholder="Pesquisar por c√≥digo ou descri√ß√£o..." class="w-full bg-gray-800 border border-gray-700 rounded-lg py-3 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
            </div>
            <div id="search-results" class="absolute z-20 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
        </div>

        <!-- Selected Products Section -->
        <div id="selected-products-container" class="mb-6">
            <!-- Products will be dynamically inserted here -->
        </div>
        
        <!-- Calculate Button -->
        <div id="calculate-button-container" class="text-center hidden">
             <button id="calculate-btn" class="btn-calculate text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity w-full md:w-auto">
                Calcular Hectolitros
            </button>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12 border-2 border-dashed border-gray-700 rounded-lg">
            <svg class="mx-auto h-12 w-12 secondary-text" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-white">Nenhum produto adicionado</h3>
            <p class="mt-1 text-sm secondary-text">Comece pesquisando um produto para adicion√°-lo √† lista.</p>
        </div>
    </div>

    <footer class="text-center py-4 mt-8 text-sm secondary-text">
        <p>Desenvolvido por Leonardo Araujo</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            const selectedProductsContainer = document.getElementById('selected-products-container');
            const totalHlElement = document.getElementById('total-hl');
            const emptyState = document.getElementById('empty-state');
            const calculateBtn = document.getElementById('calculate-btn');
            const calculateButtonContainer = document.getElementById('calculate-button-container');
            
            // --- STATE ---
            let allProducts = [];
            let selectedProducts = [];
            
            // --- EMBEDDED DATA ---
            const embeddedCsvData = `C√ìD. PROD.;DESCRI√á√ÉO DO PRODUTO;CATEGORIA;MARCA;QNTD. CX.;FATOR DE CONVERS√ÉO
3102;EISENBANH PILS. 600ML DESC. C/6;01-CERVEJA;42-EISENBAHN;12;0.036
7170;CERV HEINEKEN DESC 12X600ML;01-CERVEJA;85-HEINEKEN;12;0.072
7188;CERV AMSTEL ULTRA 275ML LN DES 12 UND;01-CERVEJA;88-AMSTEL;12;0.033
8163;PRAYA ORIGINAL GARRAFA 12X600ML;01-CERVEJA;53-Cerveja Praya;12;0.072
1103;CERVEJA PIL GLACIAL 24X600ML;01-CERVEJA;94-GLACIAL;24;0.144
100;BADEN 15 ANOS 600 ML CX 12;01-CERVEJA;40-BADEN - BADEN;24;0.072
2101;CERV EISENBAHN 24X600ML;01-CERVEJA;42-EISENBAHN;24;0.144
7183;CERV AMSTEL LAGER 24X600ML;01-CERVEJA;88-AMSTEL;24;0.144
1175;REFR FYS TONICA ZERO 0,350LT DES 12UN PB;49-REFRIGERANTE;06-FYS;24;0.042
800;CERVEJA GLACIAL LT 12X473ML;01-CERVEJA;94-GLACIAL;12;0.05676
1106;BADEN CHRISTMAS 600ML CX C/6;01-CERVEJA;40-BADEN - BADEN;12;0.72
1108;CERV EISEN WEISS 355 ML CX 12;01-CERVEJA;42-EISENBAHN;12;0
117;CERVEJA GLACIAL LT 12X350ML;01-CERVEJA;94-GLACIAL;12;0.042
2105;CERV EISEN PILS LT 12 X 350ML;01-CERVEJA;42-EISENBAHN;12;0.042
1035;CERV. EISEN PILSEN 0,473LT DES 12UND;01-CERVEJA;42-EISENBAHN;12;0.05676
2121;CERV. BADEN PIL.CRIST. 0350LT;01-CERVEJA;40-BADEN - BADEN;12;0.042
2122;CERV. BADEN WITBIER 0.350LT;01-CERVEJA;40-BADEN - BADEN;12;0.042
7175;CERV HEINEKEN PIL 12X473ML;01-CERVEJA;85-HEINEKEN;12;0.05676
7176;CERV HEINEKEN PIL 12X350ML;01-CERVEJA;85-HEINEKEN;12;0.042
7177;CERV HEINEKEN 0,0% 12X350ML;01-CERVEJA;85-HEINEKEN;12;0.042
7184;CERV AMSTEL LAGER 12X473ML;01-CERVEJA;88-AMSTEL;12;0.05676
7185;CERV AMSTEL LAGER 12X350ML;01-CERVEJA;88-AMSTEL;12;0.042
6102;CERV LAGUNITAS IPA 350ML LT;01-CERVEJA;48-LAGUNITAS;12;0.042
7193;CERV BLUE MOON 350ML LT;01-CERVEJA;61-BLUE MOON;12;0.042
7178;CERV HEINEKEN 0,0% 12X350ML LT SLEEK;01-CERVEJA;85-HEINEKEN;12;0.042
7189;CERV AMSTEL LAGER 0,350LT SLEEK 12UN PBR;01-CERVEJA;88-AMSTEL;12;0.042
7160;CERV HEINEKEN PIL 0,350LT SLEEK DES12UN;01-CERVEJA;85-HEINEKEN;12;0.042
7197;CERV HEINEKEN PIL 0,350LT SLEEKDES12UNPB;01-CERVEJA;85-HEINEKEN;12;0.042
8157000000;BMA AMSTEL VIBES LIMAO 6X269ML;01-CERVEJA;88-AMSTEL;12;0.01614
8158000000;BMA AMSTEL VIBES MELAN/MOR 6X269ML;01-CERVEJA;88-AMSTEL;12;0.1614
1036;CERV TIGER CRYSTAL 12X473ML;01-CERVEJA;65-TIGER;12;0.05676
1037;CERV TIGER CRYSTAL 12X350ML;01-CERVEJA;65-TIGER;12;0.042
244;CERV EISEN AMERIPA LT 350ML;01-CERVEJA;42-EISENBAHN;12;0.042
245;CERV EISEN PALE LT 350ML;01-CERVEJA;42-EISENBAHN;12;0.042
246;CERV EISEN SESS IPA LT 350ML;01-CERVEJA;42-EISENBAHN;12;0.042
7190;CERV LAGUNITAS IPA 355ML LN;01-CERVEJA;48-LAGUNITAS;12;0.0426
7199;CERV AMSTEL LAGER 0,355LN DES 2X6UN PBR;01-CERVEJA;88-AMSTEL;12;0.0426
8157;BMA AMSTEL VIBES LIMAO 6X269ML;01-CERVEJA;88-AMSTEL;6;0.01614
8158;BMA AMSTEL VIBES MELAN/MOR 6X269ML;01-CERVEJA;88-AMSTEL;6;0.1614
8164;PRAYA LAGER PURO MALTE LN 6X355ML;01-CERVEJA;53-Cerveja Praya;6;0.0213
121;CERV BADEN PL CRISTAL 12X600ML;01-CERVEJA;40-BADEN - BADEN;12;0.072
122;CERV BADEN RED ALE 600ML UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
123;CERV BADEN GOLD ALE 12X600ML;01-CERVEJA;40-BADEN - BADEN;12;0.072
128;EISEN WEISS L NECK C/ 12;01-CERVEJA;42-EISENBAHN;12;0.043
1129;CERV.BADEN BITTER 1999 UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
1136;CERV. BADEN ALE STOUT UNID.;01-CERVEJA;40-BADEN - BADEN;12;0.072
1137;CERV. BADEN WEISS UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
1138;BADEN LAGER BOCK 600 UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
1117;CERV EISENBAHN WEIZENBIER 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
1044;CERV BADEN CHOCOLATE 12X600ML;01-CERVEJA;40-BADEN - BADEN;12;0.072
182;CERV BADEN WITBIER 12X600ML;01-CERVEJA;40-BADEN - BADEN;12;0.072
153;EISEN WEIZENBOCK 0,355 LN CX 12;01-CERVEJA;42-EISENBAHN;12;0
1116;CERV BADEN AMERICA IPA 12X600ML;01-CERVEJA;40-BADEN - BADEN;12;0.072
1149;BADEN CELEBINVER 0,60L CX C/6;01-CERVEJA;40-BADEN - BADEN;12;0.72
1139;CERV. BADEN 5 GRAOS 600ML UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
2139;BADEN KAFEE 0,60L UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
2106;BADEN CHRISTMAS 600ML UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
2107;BADEN VIENNA 600ML UNID;01-CERVEJA;40-BADEN - BADEN;12;0.072
1361;CERV BADEN PEACH 12X600ML;01-CERVEJA;40-BADEN - BADEN;12;0.072
1164;CERV BADEN WITBIER 350ML;01-CERVEJA;40-BADEN - BADEN;12;0.042
1165;CERV BADEN PILCRIST 350ML;01-CERVEJA;40-BADEN - BADEN;12;0.042
1167;CERV BADEN IPA 350ML;01-CERVEJA;40-BADEN - BADEN;12;0.042
1168;CERV BADEN PEACH 350ML;01-CERVEJA;40-BADEN - BADEN;12;0.042
120;EISEN RAUCHBIER 0,355ML CX 12;01-CERVEJA;42-EISENBAHN;12;0.0426
1020;EISEN DUNKEL 0,355 LN CX 12;01-CERVEJA;42-EISENBAHN;12;0.0426
1021;CERV EISENBAHN PILSEN LN 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
1022;EISEN PILS ORG.0,355 LN CX 12;01-CERVEJA;42-EISENBAHN;12;0.0426
1023;EISEN WEISS 0,355 LN 1 UNID;01-CERVEJA;42-EISENBAHN;12;0.085
1024;EISEN WEIH ALE 0,355 LN CX 12;01-CERVEJA;42-EISENBAHN;12;0.085
1025;CERV. EISEN STRON GOLD CX 12;01-CERVEJA;42-EISENBAHN;12;0.0426
1026;CERV EISENBAHN PALE ALE 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
1027;EISEN KOLSCH L.NECK CX 12;01-CERVEJA;42-EISENBAHN;12;0.0426
1028;EISEN SAISON 0.50L CX C/12;01-CERVEJA;42-EISENBAHN;12;0.06
2108;CERV, EISEN WEISS 355 ML CX 12;01-CERVEJA;42-EISENBAHN;12;0.0426
1029;CERV EISEN F BISON 0,50L CX C/12;01-CERVEJA;42-EISENBAHN;12;0.06
1032;EISEN BELBLONALE VENTURA 0,50L CX C/12;01-CERVEJA;42-EISENBAHN;12;0
3128;EISEN WEISS L N C/12 355 ML;01-CERVEJA;42-EISENBAHN;12;0.0426
3117;EISEN WEIZENBIER C/12;01-CERVEJA;42-EISENBAHN;12;0.0426
3153;EISEN WEIZENBOCK L.N. C/12;01-CERVEJA;42-EISENBAHN;12;0.0426
3154;EISEN OKTOBERFEST L.N. C/12;01-CERVEJA;42-EISENBAHN;12;0
3150;EISEN WEIZENBIER 5 ANOS C/12;01-CERVEJA;42-EISENBAHN;12;0
903191;EISEN FLECHEIRA;01-CERVEJA;42-EISENBAHN;12;0.426
4117;EISENBAHN WEIZENBIER CX12;01-CERVEJA;42-EISENBAHN;12;0.0426
1019;CERV EISEN AMERICA IPA 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
1034;CERV EISEN SESS IPA LN 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
2128;CERV EISENBAHN WEIZENBIER 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
1039;CERV EISEN UNF LN 2X6UNX355ML;01-CERVEJA;42-EISENBAHN;12;0.0426
862;CERVEJA PIL GLACIAL 1L CX12;01-CERVEJA;94-GLACIAL;12;0.12
7182;CERV AMSTEL PIL 12X1L;01-CERVEJA;88-AMSTEL;12;0.12
134;CERVEJA EISEN LUST ALE 750ML C4;01-CERVEJA;53-Cerveja Praya;4;0.03
7191;CERV AMSTEL ULTRA 269ML LT 1X12UN;01-CERVEJA;88-AMSTEL;12;0.03228
7198000;CERV HEINEKEN PIL 0,269LT DESC 8UN PBR;01-CERVEJA;85-HEINEKEN;12;0.02152
7173;CERV HEINEKEN 4X6UNX330ML GFA DESC;01-CERVEJA;85-HEINEKEN;24;0.0792
7174;CERV HEINEKEN 0,0% 4X6UNX330ML GFA DESC;01-CERVEJA;85-HEINEKEN;24;0.0792
7192;CERV BLUE MOON 355ML 4X6UN LN;01-CERVEJA;61-BLUE MOON;24;0.0852
7400;CERV HEINEKEN 24X330ML RET;01-CERVEJA;85-HEINEKEN;24;0.0792
8162;PRAYA ORIGINAL LN 4X6UNX355ML;01-CERVEJA;53-Cerveja Praya;24;0.0852
7506;CERV HEINEKEN 4X6UNX330ML REP;01-CERVEJA;85-HEINEKEN;24;0.792
1038;CERV SOL PIL LN 4X6UNX330ML;01-CERVEJA;87-SOL;24;0.0792
7172;CERV HEINEKEN RET 24X600ML;01-CERVEJA;85-HEINEKEN;24;0.144
7198;CERV HEINEKEN LT 8X269ML;01-CERVEJA;85-HEINEKEN;8;0.02152
7401;CERV HEINEKEN 24X330ML RET;01-CERVEJA;85-HEINEKEN;24;0.0792
7179;DRAFT BEER HEINEKEN PIL 2X5L;01-CERVEJA;85-HEINEKEN;2;0.1
9191;CERV HEINEKEN PIL 0,25GFA DESC 2X 12UN;01-CERVEJA;85-HEINEKEN;24;0.06
7187;CERV HEINEKEN 2X12UNX250ML GFA;01-CERVEJA;85-HEINEKEN;24;0.06
1105;SKINKA FRUT CITR 450ML CX12;77-BEBIDA MISTA;31-BEBIDA MISTA;12;0.054
1107;SKINKA FRUT VERM 450ML CX12;77-BEBIDA MISTA;31-BEBIDA MISTA;12;0.054
1208;REFR FYS GUARANA 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
1210;REFR FYS LARANJA 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
1211;REFR FYS LIMAO 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
1212;REFR FYS TONICA 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
1215;REFR FYS TONICA ZERO 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
1216;REFR FYS LIMAO ZERO 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
1217;REFR FYS GUARANA ZERO 12X350ML;49-REFRIGERANTE;06-FYS;12;0.042
7194;REFR CLASH D FRUT VERM 12X269ML;49-REFRIGERANTE;96-Clash'D;12;0.03228
7195;REFR CLASH D LIMAO 12X269ML;49-REFRIGERANTE;96-Clash'D;12;0.03228
7196;REFR CLASH D MACA 12X269ML;49-REFRIGERANTE;96-Clash'D;12;0.03228
8159;MAMBA WATER SEM GAS 6 UND 350ML;80-AGUA;78-Mamba Water;6;0.021
8160;MAMBA WATER COM GAS 6X350ML;80-AGUA;78-Mamba Water;6;0.021
1836;CHOPP EISEN 30 LTS DRAFT BEER;01-CERVEJA;42-EISENBAHN;1;0.3
1840;CHOPP EISENBAHN 50L DRAFT BEER;01-CERVEJA;42-EISENBAHN;1;0.5
7203;DRAFT BEER BLUE MOON 30L;01-CERVEJA;61-BLUE MOON;1;0.3
6103;DRAFT BEER LAGUNITAS IPA 30L;01-CERVEJA;48-LAGUNITAS;1;0.3
7396;DRAFT BEER AMSTEL LAGER 30L;01-CERVEJA;88-AMSTEL;1;0.3
7180;DRAFT BEER HEINEKEN PILSEN 30L;01-CERVEJA;85-HEINEKEN;1;0.3
7181;DRAFT BEER HEINEKEN PILSEN 50L;01-CERVEJA;85-HEINEKEN;1;0.5
7186;DRAFT BEER AMSTEL LAGER 50L;01-CERVEJA;88-AMSTEL;1;0.5
7179000000;DRAFT BEER HEINEKEN PIL 2X5L;01-CERVEJA;85-HEINEKEN;1;0.1
`;

            // --- DATA HANDLING ---
            function initializeProductData() {
                try {
                    parseCSV(embeddedCsvData);
                } catch (error) {
                    console.error('Erro ao processar os dados embutidos:', error);
                    alert('N√£o foi poss√≠vel carregar os dados dos produtos. Verifique o console para mais detalhes.');
                }
            }

            function parseCSV(text) {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) return;

                const headers = lines[0].split(';').map(h => h.trim());
                const codProdIndex = headers.indexOf('C√ìD. PROD.');
                const descIndex = headers.indexOf('DESCRI√á√ÉO DO PRODUTO');
                const catIndex = headers.indexOf('CATEGORIA');
                const marcaIndex = headers.indexOf('MARCA');
                const fatorIndex = headers.indexOf('FATOR DE CONVERS√ÉO');

                if ([codProdIndex, descIndex, catIndex, marcaIndex, fatorIndex].includes(-1)) {
                    console.error("Um ou mais cabe√ßalhos do CSV n√£o foram encontrados. Verifique a formata√ß√£o.");
                    return;
                }

                allProducts = lines.slice(1).map((line, index) => {
                    const data = line.split(';');
                    const cod = data[codProdIndex]?.trim() || '';
                    const desc = data[descIndex]?.trim() || 'Produto sem descri√ß√£o';
                    const categoria = data[catIndex]?.trim() || 'N/A';
                    const marca = data[marcaIndex]?.trim() || 'N/A';
                    const fatorConversaoStr = data[fatorIndex]?.trim().replace(',', '.') || '0';
                    const fatorConversao = parseFloat(fatorConversaoStr) || 0;
                    
                    return {
                        id: `${cod}-${index}`,
                        cod,
                        desc,
                        categoria,
                        marca,
                        fator: fatorConversao
                    };
                });
            }

            // --- RENDERING & CALCULATION ---
            function renderSelectedProducts() {
                selectedProductsContainer.innerHTML = '';
                
                if (selectedProducts.length === 0) {
                    emptyState.classList.remove('hidden');
                    calculateButtonContainer.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    calculateButtonContainer.classList.remove('hidden');
                    selectedProducts.forEach((product, index) => {
                        const productElement = document.createElement('div');
                        productElement.className = 'list-item-enter bg-gray-800 p-4 rounded-lg mb-3 flex flex-col md:flex-row items-start md:items-center gap-4';
                        productElement.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-bold text-white">${product.desc}</p>
                                <p class="text-sm secondary-text mt-1">
                                    C√≥d: ${product.cod} | Categoria: ${product.categoria} | Marca: ${product.marca}
                                </p>
                            </div>
                            <div class="flex items-center gap-4 w-full md:w-auto">
                                <div class="flex-grow md:flex-grow-0">
                                    <label for="quantity-${product.id}" class="sr-only">Quantidade de caixas</label>
                                    <input type="number" id="quantity-${product.id}" min="0" value="${product.quantity}" 
                                           class="quantity-input w-full md:w-24 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-center focus:outline-none focus:ring-2 focus:ring-green-500" 
                                           data-index="${index}">
                                </div>
                                <div class="text-right w-20">
                                    <p class="text-lg font-semibold total-hl-color">${product.hl.toFixed(3)} HL</p>
                                </div>
                                <button class="remove-btn text-gray-500 hover:text-red-500 transition-colors" data-index="${index}" title="Remover produto">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        `;
                        selectedProductsContainer.appendChild(productElement);
                    });
                }
            }

            function renderSearchResults(results) {
                searchResultsContainer.innerHTML = '';
                if (results.length > 0) {
                    searchResultsContainer.classList.remove('hidden');
                    results.slice(0, 10).forEach(product => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-3 hover:bg-gray-700 cursor-pointer transition-colors';
                        resultItem.innerHTML = `
                            <p class="font-semibold">${product.desc}</p>
                            <p class="text-sm secondary-text">C√≥d: ${product.cod}</p>
                        `;
                        resultItem.addEventListener('click', () => addProduct(product));
                        searchResultsContainer.appendChild(resultItem);
                    });
                } else {
                    searchResultsContainer.classList.add('hidden');
                }
            }

            function calculateAndRender() {
                let grandTotal = 0;
                
                selectedProducts.forEach(p => {
                    const inputElement = document.getElementById(`quantity-${p.id}`);
                    if (inputElement) {
                        const quantity = parseInt(inputElement.value, 10) || 0;
                        p.quantity = quantity; // Update state from DOM
                    }
                    p.hl = p.quantity * p.fator; // Calculate and store HL
                    grandTotal += p.hl;
                });

                totalHlElement.textContent = grandTotal.toFixed(3);
                renderSelectedProducts(); // Re-render to show individual HL values
            }

            // --- EVENT HANDLERS & LOGIC ---
            function handleSearch() {
                const query = searchInput.value.toLowerCase().trim();
                if (query.length < 2) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                const filteredProducts = allProducts.filter(p => 
                    p.desc.toLowerCase().includes(query) || 
                    p.cod.toLowerCase().includes(query)
                );
                renderSearchResults(filteredProducts);
            }

            function addProduct(product) {
                const isAlreadySelected = selectedProducts.some(p => p.id === product.id);
                if (!isAlreadySelected) {
                    selectedProducts.unshift({ ...product, quantity: 1, hl: 0 });
                    // Just render the new product, don't calculate yet
                    renderSelectedProducts();
                }
                searchInput.value = '';
                searchResultsContainer.classList.add('hidden');
                searchInput.focus();
            }
            
            function handleRemoveProduct(e) {
                const removeButton = e.target.closest('.remove-btn');
                if (removeButton) {
                    const index = removeButton.dataset.index;
                    if (index !== undefined) {
                        selectedProducts.splice(index, 1);
                        // After removing, recalculate everything based on remaining items
                        calculateAndRender();
                    }
                }
            }
            
            function handleKeydown(e) {
                if (e.key === 'Enter' && e.target.classList.contains('quantity-input')) {
                    calculateAndRender();
                }
            }

            // --- INITIALIZATION ---
            initializeProductData();

            // --- EVENT LISTENERS ---
            searchInput.addEventListener('input', handleSearch);
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target)) {
                    searchResultsContainer.classList.add('hidden');
                }
            });
            selectedProductsContainer.addEventListener('click', handleRemoveProduct);
            selectedProductsContainer.addEventListener('keydown', handleKeydown);
            calculateBtn.addEventListener('click', calculateAndRender);
        });
    </script>

</body>
</html>
